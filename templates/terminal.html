<div class="terminal-section" style="margin-top: 20px;">
    <h3>Command Terminal</h3>
    <button id="open-terminal" class="button">Open Terminal</button>
    <div id="terminal-window" style="display: none; margin-top: 10px;">
        <pre id="terminal-output" style="background: #1e1e1e; color: #00ff00; padding: 10px; height: 200px; overflow-y: auto;"></pre>
        <textarea id="command-input" placeholder="Enter command..." rows="3" cols="60"></textarea>
        <button id="send-command" class="button">Send Command</button>
    </div>
</div>

<script>
    let socket;

    document.addEventListener('DOMContentLoaded', () => {
        const hardwareId = "{{ device.hardware_id }}";
        socket = new WebSocket(`ws://${window.location.host}/ws/${hardwareId}`);

        socket.onopen = () => {
            console.log('WebSocket connection established');
        };

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            const output = document.getElementById('terminal-output');
            if (data.type === 'command_result') {
                output.textContent += `> ${data.result}\n`;
            } else if (data.type === 'command') {
                output.textContent += `> Server sent command: ${data.command}\n`;
            }
            output.scrollTop = output.scrollHeight; // Auto-scroll to bottom
        };

        socket.onclose = () => {
            console.log('WebSocket connection closed');
        };

        socket.onerror = (error) => {
            console.error('WebSocket error:', error);
        };

        document.getElementById('open-terminal').addEventListener('click', () => {
            document.getElementById('terminal-window').style.display = 'block';
        });

        document.getElementById('send-command').addEventListener('click', function() {
            const command = document.getElementById('command-input').value;
            if (command.trim() === '') {
                alert('Please enter a command');
                return;
            }

            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: 'command', hardware_id: hardwareId, command: command }));
                document.getElementById('command-input').value = '';
            } else {
                console.error('WebSocket is not connected');
            }
        });
    });
</script>
